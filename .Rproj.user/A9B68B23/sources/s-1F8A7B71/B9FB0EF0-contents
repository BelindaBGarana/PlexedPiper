---
title: |
    Suggested TMT processing pipeline. Variant 1.

output:
  BiocStyle::html_document
---


```{r setup, echo=FALSE}
knitr::opts_chunk$set(message=FALSE, warning = FALSE)
# knitr::opts_chunk$set(echo=T, message=F, warning=F, fig.align='center', out.width='10cm')
```


# Suggested Pipeline


```{r all_of_it, echo=FALSE}
library(PlexedPiper)
library(MSnID)

# Prepare MS/MS IDs
path_to_MSGF_results <- system.file(
   "extdata/global/msgf_output", 
   package = "PlexedPiperTestData")
msnid <- read_msgf_data(path_to_MSGF_results)
msnid <- correct_peak_selection(msnid)
show(msnid)

msnid <- filter_msgf_data_peptide_level(msnid, 0.01)
show(msnid)

path_to_FASTA <- system.file(
   "extdata/Rattus_norvegicus_NCBI_RefSeq_2018-04-10.fasta.gz", 
   package = "PlexedPiperTestData")
temp_dir <- tempdir()
file.copy(path_to_FASTA, temp_dir)
path_to_FASTA <- file.path(temp_dir, basename(path_to_FASTA))
path_to_FASTA_gene <- remap_accessions_refseq_to_gene_fasta(
   path_to_FASTA, organism_name="Rattus norvegicus")

msnid <- remap_accessions_refseq_to_gene(msnid, organism_name="Rattus norvegicus")

msnid <- compute_num_peptides_per_1000aa(msnid, path_to_FASTA_gene)
msnid <- filter_msgf_data_protein_level(msnid, 0.01)
show(msnid)

msnid <- infer_parsimonious_accessions(msnid, unique_only=T)
show(msnid)

# remove decoy accessions
msnid <- apply_filter(msnid, "!isDecoy")


# prepare MASIC
path_to_MASIC_results <- system.file("extdata/global/masic_output", package = "PlexedPiperTestData")
masic_data <- read_masic_data(path_to_MASIC_results, extra_metrics=TRUE)
head(masic_data)
masic_data <- filter_masic_data(masic_data, 0.5, 0)


# Creating cross-tab
library(readr)
fractions <- read_tsv(system.file("extdata/study_design/fractions.txt", package = "PlexedPiperTestData"))
samples <- read_tsv(system.file("extdata/study_design/samples.txt", package = "PlexedPiperTestData"))
references <- read_tsv(system.file("extdata/study_design/references.txt", package = "PlexedPiperTestData"))
aggregation_level <- c("PlexID","accession")

out <- create_crosstab(msnid, masic_data, aggregation_level, fractions, samples, references)
dim(out)
head(out)
```
